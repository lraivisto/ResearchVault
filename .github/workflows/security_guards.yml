name: Security Guards

on:
  push:
    branches: [ main, feat/portal ]
  pull_request:
    branches: [ main, feat/portal ]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard 1 - Build Artifacts & Hygiene
        run: |
          # Fail if node_modules exists anywhere (should be ignored)
          if find . -name "node_modules" -type d | grep -q "."; then
            echo "❌ ERROR: node_modules/ directory found in repository. This is forbidden."
            exit 1
          fi
          # Fail if *.egg-info exists in repo (should be ignored)
          if find . -name "*.egg-info" -type d | grep -q "."; then
            echo "❌ ERROR: .egg-info directory found in repository. This is forbidden."
            exit 1
          fi
          echo "✅ Build hygiene verified."

      - name: Guard 2 & 3 - SKILL.md Metadata Checks
        run: |
          if ! grep -q "disable-model-invocation: true" SKILL.md; then
            echo "❌ ERROR: SKILL.md missing 'disable-model-invocation: true' in frontmatter."
            exit 1
          fi
          if ! grep -q "homepage:" SKILL.md; then
            echo "❌ ERROR: SKILL.md missing 'homepage' in frontmatter."
            exit 1
          fi
          echo "✅ Metadata flags present."

      - name: Guard 4 - No UV mentions in docs
        run: |
          # We allow 'uv' if it's explicitly marked as optional/Standard-fallback
          # But we fail if 'uv venv' or 'uv pip' are presented as the primary install path.
          if grep -riE "uv venv|uv pip|bins.*uv" SKILL.md README.md | grep -v "Standard"; then
             echo "❌ ERROR: Primary documentation contains 'uv' requirements."
             exit 1
          fi
          echo "✅ Documentation clean."

  functional-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install CA Certificates
        run: sudo apt-get update && sudo apt-get install -y ca-certificates

      - name: Install Dependencies
        run: |
          pip install -e .
          pip install pytest responses pytest-mock certifi

      - name: Run SSRF Unit Tests
        run: |
          python3 -m pytest tests/exploit_ssrf.py

      - name: Run CLI Smoke Test
        run: |
          export RESEARCHVAULT_DB=/tmp/ci_vault.db
          # Use HTTP for smoke test to avoid CI TLS issues; SSRF logic remains fully tested.
          python3 scripts/vault.py init --id ci-test --objective "CI Verification"
          python3 scripts/vault.py scuttle "http://example.com" --id ci-test
          python3 scripts/vault.py list
          # Confirm blocks
          if python3 scripts/vault.py scuttle "http://localhost" --id ci-test 2>&1 | grep -q "Blocked host"; then
            echo "✅ SSRF Localhost Block Verified."
          else
            echo "❌ ERROR: SSRF Localhost Block FAILED."
            exit 1
          fi
