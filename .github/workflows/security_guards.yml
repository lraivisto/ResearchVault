name: Security Guards

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard 1 - No Portal on Main
        run: |
          if [ -d "portal" ]; then
            echo "❌ ERROR: portal/ directory found on main branch. This is forbidden."
            exit 1
          fi
          echo "✅ Portal absent."

      - name: Guard 2 & 3 - SKILL.md Metadata Checks
        run: |
          if ! grep -q "disable-model-invocation: true" SKILL.md; then
            echo "❌ ERROR: SKILL.md missing 'disable-model-invocation: true' in frontmatter."
            exit 1
          fi
          if ! grep -q "homepage:" SKILL.md; then
            echo "❌ ERROR: SKILL.md missing 'homepage' in frontmatter."
            exit 1
          fi
          echo "✅ Metadata flags present."

      - name: Guard 4 - No UV mentions in docs
        run: |
          if grep -ri "uv" SKILL.md README.md | grep -v "Standard"; then
            # We allow it in the 'Fast Path' section if it's explicitly marked as optional
            # but we want to fail if it's treated as a requirement.
            # For this strict guard, we check for 'uv venv' or 'uv pip' as primary instructions.
            if grep -riE "uv venv|uv pip|bins.*uv" SKILL.md README.md; then
               echo "❌ ERROR: Primary documentation contains 'uv' requirements."
               exit 1
            fi
          fi
          echo "✅ Documentation clean."

  functional-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Dependencies
        run: |
          pip install -e .
          pip install pytest responses pytest-mock

      - name: Run SSRF Unit Tests
        run: |
          # Use the hardened exploit_ssrf.py we created
          python3 -m pytest tests/exploit_ssrf.py

      - name: Run CLI Smoke Test
        run: |
          export RESEARCHVAULT_DB=/tmp/ci_vault.db
          # Basic CLI flow
          python3 scripts/vault.py init --id ci-test --objective "CI Verification"
          python3 scripts/vault.py scuttle "https://example.com" --id ci-test
          python3 scripts/vault.py list
          # Confirm blocks
          if python3 scripts/vault.py scuttle "http://localhost" --id ci-test 2>&1 | grep -q "Blocked host"; then
            echo "✅ SSRF Localhost Block Verified."
          else
            echo "❌ ERROR: SSRF Localhost Block FAILED."
            exit 1
          fi
