import pytest
import responses
from scripts.scuttle import WebScuttler, ScuttleError, ScuttleConfig

@pytest.fixture
def scuttler():
    return WebScuttler()

@pytest.fixture
def config():
    return ScuttleConfig(allow_private_networks=False)

def test_block_localhost(scuttler, config):
    with pytest.raises(ScuttleError, match="Blocked host: 'localhost'"):
        scuttler.scuttle("http://localhost", config)

def test_block_private_ip(scuttler, config):
    with pytest.raises(ScuttleError, match="restricted IP: 192.168.1.1"):
        scuttler.scuttle("http://192.168.1.1", config)

def test_block_link_local(scuttler, config):
    with pytest.raises(ScuttleError, match="restricted IP: 169.254.169.254"):
        scuttler.scuttle("http://169.254.169.254", config)

def test_allow_override(scuttler):
    # This test ensures the override flag works for advanced users
    config_allow = ScuttleConfig(allow_private_networks=True)
    
    with responses.RequestsMock() as rsps:
        rsps.add(responses.GET, "http://127.0.0.1", body="<p>Local content</p>", status=200)
        result = scuttler.scuttle("http://127.0.0.1", config_allow)
        assert result["content"] == "Local content"

def test_block_non_http(scuttler, config):
    with pytest.raises(ScuttleError, match="Only http/https"):
        scuttler.scuttle("file:///etc/passwd", config)
